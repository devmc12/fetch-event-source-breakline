async function x(r,t){let n=r.getReader(),e;for(;!(e=await n.read()).done;)t(e.value)}function A(r){let t,n,e,c=!1;return function(s){t===void 0?(t=s,n=0,e=-1):t=k(t,s);let o=t.length,a=0;for(;n<o;){c&&(t[n]===10&&(a=++n),c=!1);let d=-1;for(;n<o&&d===-1;++n)switch(t[n]){case 58:e===-1&&(e=n-a);break;case 13:c=!0;case 10:d=n;break}if(d===-1)break;r(t.subarray(a,d),e),a=n,e=-1}a===o?t=void 0:a!==0&&(t=t.subarray(a),n-=a)}}var l=null;function L(r,t,n){let e=E(),c=new TextDecoder;return function(s,o){if(s.length===0)n?.(e),e=E(),l=null;else if(o>0){let a=c.decode(s.subarray(0,o)),d=o+(s[o+1]===32?2:1),i=c.decode(s.subarray(d));if(i.startsWith("{")&&!i.endsWith("}")){l=i,n?.(e),e=E();return}switch(a){case"data":e.data=e.data?e.data+`
`+i:i;break;case"event":e.event=i;break;case"id":r(e.id=i);break;case"retry":let g=parseInt(i,10);isNaN(g)||t(e.retry=g);break;default:l&&(e.data=(e.data?e.data+`
`:"")+l+a+":"+i),l=null}}}}function k(r,t){let n=new Uint8Array(r.length+t.length);return n.set(r),n.set(t,r.length),n}function E(){return{data:"",event:"",id:"",retry:void 0}}var b="text/event-stream",M=1e3,U="last-event-id";function N(r,{signal:t,headers:n,onopen:e,onmessage:c,onclose:p,onerror:s,openWhenHidden:o,fetch:a,...d}){return new Promise((i,g)=>{let f={...n};f.accept||(f.accept=b);let v;function S(){v.abort(),document.hidden||w()}o||document.addEventListener("visibilitychange",S);let R=M,h=0;function m(){document.removeEventListener("visibilitychange",S),window.clearTimeout(h),v.abort()}t?.addEventListener("abort",()=>{m(),i()});let I=a??window.fetch,T=e??C;async function w(){v=new AbortController;try{let y=await I(r,{...d,headers:f,signal:v.signal});await T(y),await x(y.body,A(L(u=>{u?f[U]=u:delete f[U]},u=>{R=u},c))),p?.(),m(),i()}catch(y){if(!v.signal.aborted)try{let u=s?.(y)??R;window.clearTimeout(h),h=window.setTimeout(w,u)}catch(u){m(),g(u)}}}w()})}function C(r){let t=r.headers.get("content-type");if(!t?.startsWith(b))throw new Error(`Expected content-type to be ${b}, Actual: ${t}`)}export{b as EventStreamContentType,N as fetchEventSource};
