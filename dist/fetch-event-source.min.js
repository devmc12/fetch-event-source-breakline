async function R(r,e){let t=r.getReader(),n;for(;!(n=await t.read()).done;)e(n.value)}function x(r){let e,t,n,s=!1;return function(o){e===void 0?(e=o,t=0,n=-1):e=M(e,o);let i=e.length,a=0;for(;t<i;){s&&(e[t]===10&&(a=++t),s=!1);let c=-1;for(;t<i&&c===-1;++t)switch(e[t]){case 58:n===-1&&(n=t-a);break;case 13:s=!0;case 10:c=t;break}if(c===-1)break;r(e.subarray(a,c),n),a=t,n=-1}a===i?e=void 0:a!==0&&(e=e.subarray(a),t-=a)}}function A(r,e,t){let n=S(),s=new TextDecoder;return function(o,i){if(o.length===0)t?.(n),n=S();else if(i>0){let a=s.decode(o.subarray(0,i)),c=i+(o[i+1]===32?2:1),d=s.decode(o.subarray(c));switch(a){case"data":n.data=n.data?n.data+`
`+d:d;break;case"event":n.event=d;break;case"id":r(n.id=d);break;case"retry":let v=parseInt(d,10);isNaN(v)||e(n.retry=v);break}}}}function M(r,e){let t=new Uint8Array(r.length+e.length);return t.set(r),t.set(e,r.length),t}function S(){return{data:"",event:"",id:"",retry:void 0}}var y="text/event-stream",T=1e3,L="last-event-id";function k(r,{signal:e,headers:t,onopen:n,onmessage:s,onclose:b,onerror:o,openWhenHidden:i,fetch:a,...c}){return new Promise((d,v)=>{let l={...t};l.accept||(l.accept=y);let f;function w(){f.abort(),document.hidden||m()}i||document.addEventListener("visibilitychange",w);let E=T,p=0;function h(){document.removeEventListener("visibilitychange",w),window.clearTimeout(p),f.abort()}e?.addEventListener("abort",()=>{h(),d()});let U=a??window.fetch,I=n??N;async function m(){f=new AbortController;try{let g=await U(r,{...c,headers:l,signal:f.signal});await I(g),await R(g.body,x(A(u=>{u?l[L]=u:delete l[L]},u=>{E=u},s))),b?.(),h(),d()}catch(g){if(!f.signal.aborted)try{let u=o?.(g)??E;window.clearTimeout(p),p=window.setTimeout(m,u)}catch(u){h(),v(u)}}}m()})}function N(r){let e=r.headers.get("content-type");if(!e?.startsWith(y))throw new Error(`Expected content-type to be ${y}, Actual: ${e}`)}export{y as EventStreamContentType,k as fetchEventSource};
